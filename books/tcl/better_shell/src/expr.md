# サブ言語 Tcl 式（expr コマンド）

[EIAS](puts.html#全ては文字列-eias---everything-is-a-string) の節で、

> コマンドに渡された文字列にどんな意味を持たせるかは、そのコマンドの自由です

と書きました。その典型例が `expr` [(→公式マニュアル)](https://www.tcl-lang.org/man/tcl8.5/TclCmd/expr.htm) コマンドです。 expr コマンドは引数を、コマンドとは別の計算に特化したミニ言語、 Tcl 式（Tcl expression）
として解釈します。expr コマンド以外にも、 `if`, `while`, `for` コマンドが
同じく Tcl 式を解釈します。

Tcl 式は（コマンドがコマンド名を先頭に置く、前置き(prefix)記法であるのに対し）
一般の計算式や C 言語に似せた、演算子を項の間に書く中置き(infix)記法です。
計算の優先順位を括弧で明示することも可能です。

（演算子以外の）計算の各項には、変数置換とコマンド置換を書くことが出来ます。

```tcl
expr {3 + 8 - 1}
# => 10
set x 3; set y 8;
expr {$x * $y - [string length xxxx]}
# => 20
```

数値計算では（他の言語と同様に）
整数と実数の使い分けを意識する必要があります。

```tcl
expr {4 / 8}
# => 0
expr {4.0 / 8}
# => 0.5
```

整数・実数の計算だけでなく、文字列の比較や、 文字列が Tcl リストに含まれるか否かの検査なども書くことが出来ます。

```tcl
set foo bar
expr {$foo eq "bar"}
# => 1
expr {$foo ne "bar"}
# => 0
expr {$foo in {foo bar baz}}
# => 1
expr {$foo ni {foo bar baz}}
# => 0
```


## expr と quote `{..}`

古い Tcl の記述では、計算式を `{..}` で囲わずに

```tcl
set val [expr $x + $y * 3]
```

のように書いているものもあります。これは、現代の Tcl では２つの点でお勧め出来ません。

* 実行速度の問題  
  現代の Tcl では、手続き内の expr コマンドは、数式が `{..}` で囲われている時に限り、実行の最適化を行ないます。（ `{..}` で囲われていない場合、数式が動的に変化することになるからです。）
* セキュリティーホールの元となるリスク  
  `{..}` で囲われない数式は、 Tcl interpreter と expr によって二度の評価を受けます。もしこの数式を構成する値がユーザー入力などで与えられる場合、そこに `$x` や `[..]` が入り込むことでセキュリティーホールとなる。
