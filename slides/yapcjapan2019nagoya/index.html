<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="/revealjs/css/reveal.css">
    <link rel="stylesheet" href="/revealjs/css/theme/beige.css" id="theme">
    <link rel="stylesheet" href="/revealjs/lib/css/zenburn.css">
    <!-- If the query includes 'print-pdf', use the PDF print sheet -->
    <script>
      document.write( '<link rel="stylesheet" href="/revealjs/css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
    </script>
    <!--[if lt IE 9]>
      <script src="/revealjs/lib/js/html5shiv.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="index.css">
  </head>

  <body>
    <div class="reveal">
      <div class="slides">
<section>
<section data-markdown>
<script type='text/template'>
### Rust に入門したくて！
### libperl を bindgen して
### Perl の ASTを舐め始めた話

<img src="img/myfistrect.jpg" style="width: 64px; height: 64px">
**@hkoba**  
[hkoba.github.io/](http://hkoba.github.io/)  
[`yapcjapan2019nagoya`](http://hkoba.github.io/slides/yapcjapan2019nagoya/)
</script>
</section>
<section data-markdown>
<script type='text/template'>
<!-- .slide: class="tiny" -->

### 誰に何を話すか

- Rust に入門する話が一番広そう(背中を押してほしい人？)
  - 前提の再確認(置かれた立場、悩みを言語化して共有)
  - なぜ Rust ? (理由を言語化して欲しい)
  - どう Rust を導入する？(業務へ導入する戦略も、言語化して欲しい)
- Perl の内部に詳しい人と、それ以外と、両方を喜ばせたい
</script>
</section>
</section>
<section data-markdown>
<script type='text/template'>
<!-- .slide: class="small" -->

### 自己紹介

* 大昔 Perl/Tk の日本語化 <small>(1995〜96)</small>
* <small>(流行らなかった)</small>MMO ゲームのサーバー側開発 C++ <small>(1997〜2000)</small>
* 組み込み Linux <small>知人と起業</small><small>(2000〜2002)</small>
* 今は<small>(名ばかりの)</small>フリーランスな Perl屋
</script>
</section>
<section data-markdown>
<script type='text/template'>
### 今日の内容

1. 動機<small>（なんで Rust で libperl？）</small>
2. どんな学習プロセスを<small>辿ったか</small>
  - 使えるか？確認<small>(技術検証)</small>
  - bindgen してみた
</script>
</section>
<section data-markdown>
<script type='text/template'>
## 1. 動機
</script>
</section>
<section data-markdown>
<script type='text/template'>
### おっさんプログラマーの悩み

#### 心血注いで築き上げたライブラリ資産が
#### `言語ごと流行から外れて`
#### 負債呼ばわりされる現実

### グギギ
</script>
</section>
<section>
<section data-markdown>
<script type='text/template'>
<!-- .slide: class="small" -->

#### 流行りの言語のメリットは、分かる
#### 型に守られたパターンマッチとか、欲しい

<small>ex. [MinCaml の inline.ml (抜粋)](http://esumii.github.io/min-caml/min-caml.html#inline_g)</small>

![](img/mincaml-inline-g.png)
</script>
</section>
<section data-markdown>
<script type='text/template'>
<small>
この `IfEq(x, y, e1, e2)` は `if x = y then e1 else e2`
</small>

http://esumii.github.io/min-caml/tutorial-mincaml-9.htm
</script>
</section>
</section>
<section data-markdown>
<script type='text/template'>
### けど既存の資産の総書き直しは…
#### 難しい…

* 体力・時間
* 顧客にとっての価値は？？
</script>
</section>
<section data-markdown>
<script type='text/template'>
#### … Perl は内部に AST を持ってますね …

[![](img/perldoc-perlinterp-optrees.png)](https://perldoc.perl.org/5.30.0/perlinterp.html#OP-TREES)
</script>
</section>
<section data-markdown>
<script type='text/template'>
## この Perl の AST を
#### 流行りの言語から
### 舐められないか？
</script>
</section>
<section data-markdown>
<script type='text/template'>
#### そういえば Rust がそろそろ落ち着いたぽい？

[日本語で、本が出るくらいに](https://gihyo.jp/book/2019/978-4-297-10559-4)

![](http://image.gihyo.co.jp/assets/images/cover/2019/9784297105594.jpg)
</script>
</section>
<section data-markdown>
<script type='text/template'>
いっちょ触ってみますか！
</script>
</section>
<section data-markdown>
<script type='text/template'>
#### ところで
## なぜ Rust？

* 言語A の GC + 別の言語B のGC  
→ 深い注意が必要
* Rust は GC を持たない<small>（代わりに寿命を静的に型検査）</small>  
→ GC を持つ他の言語処理系と組合せやすそう
</script>
</section>
<section data-markdown>
<script type='text/template'>
### 2. どんな学習プロセスを<small>辿ったか</small>
</script>
</section>
<section data-markdown>
<script type='text/template'>
<!-- .slide: class="small" -->

### まず技術検証

1. チュートリアルには手を付ける<small>（最低限の知識を得る）</small>
2. 最も簡単そうな<small>（でも実現すると個人的にアガる）</small>目標を定める
3. コード書く  
→ 動かない<small>(コンパイル通らない, SEGVする)</small>  
→ 本に戻って知識を補う/StackOverflow検索  
→ ∞
</script>
</section>
<section data-markdown>
<script type='text/template'>
<!-- .slide: class="small" -->

### 具体的には

1. チュートリアル：[The book](https://doc.rust-lang.org/book/title-page.html) <small>([日本語訳](https://doc.rust-jp.rs/book/second-edition/))</small>
  1. `Getting Started` <small>/ `事始め`</small>
  2. `Programming a Guessing Game` <small>/ `数当てゲームをプログラムする`</small>
2. 目標は `perl_parse()` 
3. 実践Rust入門の `12章. FFI` を読みながら、perl_parse() を呼ぶコードを書いてみる
  - 理解に必要な語/概念が出てくる章を芋づる式に読む
</script>
</section>
<section>
<section data-markdown>
<script type='text/template'>
### [perl_parse()](https://perldoc.perl.org/5.30.0/perlapi.html#perl_parse) とは

コンパイルだけを済ませる Perl の API

```C
int	perl_parse(PerlInterpreter *my_perl,
                  XSINIT_t xsinit, int argc,
                  char **argv, char **env)
```

使い方<small>[perlinterp.pod](https://metacpan.org/pod/distribution/perl/pod/perlinterp.pod#ELEMENTS-OF-THE-INTERPRETER) や [perlembed.pod](https://metacpan.org/pod/distribution/perl/pod/perlembed.pod#Adding-a-Perl-interpreter-to-your-C-program)参照</small>

```C
PerlInterpreter *my_perl = perl_alloc();

perl_construct(my_perl);

if (!perl_parse(my_perl, xs_init, argc, argv, (char **)NULL))

    perl_run(my_perl);
```
</script>
</section>
<section data-markdown>
<script type='text/template'>
`-c` オプション付きで perl を呼び出すと、perl_parse までで
ストップしてくれる

```sh
perl -ce 'print "FOO\n";
if ;
print "BAR";
'
syntax error at -e line 2, near "if ;"
-e had compilation errors.
```
</script>
</section>
</section>
<section data-markdown>
<script type='text/template'>
### 同じことを Rust でしたい

```C
PerlInterpreter *my_perl = perl_alloc();

perl_construct(my_perl);

if (!perl_parse(my_perl, xs_init, argc, argv, (char **)NULL))

    perl_run(my_perl);
```

`PerlInterpreter` をどうするか…

最短手は？
</script>
</section>
<section data-markdown>
<script type='text/template'>
### 「実践Rust入門」に書いてありました

`12-2-7` Opaque と空の列挙型

Opaque == 不透明, 中が見えない

ポインタの先のことは、Rust 側では関知しない、というアプローチ
</script>
</section>
<section data-markdown>
<script type='text/template'>
`PerlInterpreter` と `XSINIT_t` は、これで行ける

```rust
enum PerlInterpreter {}
enum XsinitT {}
```

それへのポインタ

```rust
let my_perl: *mut PerlInterpreter = ...;
```

<small>(rust のコンパイラが名前の付け方に警告を出すので、この時はそれに従った)</small>
</script>
</section>
<section data-markdown>
<script type='text/template'>
### 他の型

Cの文字、int、void

```rust
use std::os::raw::{c_char, c_int, c_void};
```

文字列へのポインタのポインタ<small>(C の `char** argv`)</small>

```
let my_argv: *const *const c_char = ...;
```
</script>
</section>
<section data-markdown>
<script type='text/template'>
### 宣言は書けた？

```rust
extern "C" {
    fn perl_parse(
        my_perl: *mut PerlInterpreter,
        xsinit: *const XsinitT,
        argc: c_int,
        argv: *const *const c_char,
        env: *const *const c_char,
    ) -> c_int;
}
```
</script>
</section>
<section data-markdown>
<script type='text/template'>
<!-- .slide: class="small" -->

### `char **argv` をどう作る？

```rust
use std::ffi::CString; // Rust で割り付けて C に貸す文字列

let s = CString::new("foo").unwrap();

let p = unsafe {s.as_ptr()};
```

* lifetime を理解せずに CString を使って SEGV、悩む
</script>
</section>
<section data-markdown>
<script type='text/template'>
* [StackOverflow の記事](https://stackoverflow.com/questions/34379641/how-do-i-convert-rust-args-into-the-argc-and-argv-c-equivalents)で解決

![](img/so-rust-args-cstring.png)
</script>
</section>
<section data-markdown>
<script type='text/template'>
### 動いた！

![](img/handmade-ffi-worked.png)

<small>ちゃんと `perl -wc` と同じ働きをしてる！</small>
</script>
</section>
<section data-markdown>
<script type='text/template'>
## 喜びの雄叫び！

[![](img/gist-rust-libperl.png)](https://twitter.com/hkoba/status/1159056109216288771)
</script>
</section>
<section data-markdown>
<script type='text/template'>
## 次は bindgen の検証
</script>
</section>
<section data-markdown>
<script type='text/template'>
### bindgen とは

C のヘッダを渡すと Rust のヘッダを吐いてくれる！

```sh
$ bindgen input.h -o bindings.rs
```

<small>
https://rust-lang.github.io/rust-bindgen/command-line-usage.html
</small>
</script>
</section>
<section data-markdown>
<script type='text/template'>
→とりあえず呼んでみて、使用に耐えるか調べる
</script>
</section>
<section data-markdown>
<script type='text/template'>
`wrapper.h` を書く。<small>↓(libperl だとこれだけ)</small>

```C
#include <EXTERN.h>               /* from the Perl distribution     */
#include <perl.h>                 /* from the Perl distribution     */
```

bindgen を試しに呼んで、出た Rust コードを読む

```sh
% ccopts=($(
   perl -MExtUtils::Embed -e ccopts |
   perl -nle 'print for grep /^-[DI]/, split'
  )

% bindgen wrapper.h -- $ccopts | less
```

→行けそう
</script>
</section>
<section data-markdown>
<script type='text/template'>
#### ビルド→エラー出る

![](img/bindgen-plain-error.png)

けど、redefined はおかしい
</script>
</section>
<section data-markdown>
<script type='text/template'>
#### ためしにエラーになるコードを手で削ってみる

→ビルド通るじゃん？
</script>
</section>
<section data-markdown>
<script type='text/template'>
#### ちょっと Perl::new() とか parse() とか書いてみる

→動いた！
</script>
</section>
<section data-markdown>
<script type='text/template'>
https://twitter.com/hkoba/status/1173468427706490880
</script>
</section>
<section data-markdown>
<script type='text/template'>
* libperl
  - Perl の Configure で `-Duseshrplib` 
  - [Building a shared Perl library](https://metacpan.org/pod/distribution/perl/INSTALL#Building-a-shared-Perl-library)

* `-Dusethreads`
</script>
</section>

      </div>
    </div>

    <script src="/revealjs/lib/js/head.min.js"></script>
    <script src="/revealjs/js/reveal.js"></script>

    <script>
      Reveal.initialize({
        width: 960,
        height: 700,
        controls: true,
        progress: true,
        history: true,
        center: true,
        theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
        transitionSpeed: Reveal.getQueryHash().speed || 'fast', // 
        transition: Reveal.getQueryHash().transition || 'linear', // default/cube/page/concave/zoom/linear/fade/none
        // Optional libraries used to extend on reveal.js
        dependencies: [
          { src: '/revealjs/lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: '/revealjs/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: '/revealjs/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: '/revealjs/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: '/revealjs/plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
          { src: '/revealjs/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
        ]
      });
    </script>
  </body>
</html>

