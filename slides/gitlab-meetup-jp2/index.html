<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="stylesheet" href="/revealjs/css/reveal.css">
    <link rel="stylesheet" href="/revealjs/css/theme/beige.css" id="theme">
    <link rel="stylesheet" href="/revealjs/lib/css/zenburn.css">
    <!-- If the query includes 'print-pdf', use the PDF print sheet -->
    <script>
      document.write( '<link rel="stylesheet" href="/revealjs/css/print/' + ( window.location.search.match( /print-pdf/gi ) ? 'pdf' : 'paper' ) + '.css" type="text/css" media="print">' );
    </script>
    <!--[if lt IE 9]>
      <script src="/revealjs/lib/js/html5shiv.js"></script>
    <![endif]-->
    <link rel="stylesheet" type="text/css" href="index.css">
  </head>

  <body>
    <div class="reveal">
      <div class="slides">
<section data-markdown>
<script type='text/template'>
### Gitea, Redmine, CVSTrac から GitLab への
### import で得た知見を駆け足で

<img src="img/myfistrect.jpg" style="width: 64px; height: 64px">
**@hkoba** [hkoba.github.io](https://hkoba.github.io/)
→ [`GitLab Meetup JP` `#2`](https://hkoba.github.io/slides/gitlab-meetup-jp2/)
</script>
</section>
<section data-markdown>
<script type='text/template'>
### 自己紹介

* <small>(名ばかりの)</small>フリーランス・プログラマ
  * 普段は Perl, TclTk, Zsh, Emacs Lisp
</script>
</section>
<section data-markdown>
<script type='text/template'>
<!-- .slide: class="small" -->

### 私の Issue Tracker 遍歴

- [CVSTrac](http://www.cvstrac.org/home/doc/trunk/www/index.html)<small>（[SQLite](https://www.sqlite.org/index.html) の [drh](https://en.wikipedia.org/wiki/D._Richard_Hipp) が自分のために作った）</small>
- [Redmine](https://redmine.jp/)
- GitHub <small>(これのみ SaaS)</small>
- [Phabricator](https://www.phacility.com/phabricator/)
- [Gitea](https://gitea.io/en-us/)


…そして GitLab へ
</script>
</section>
<section data-markdown>
<script type='text/template'>
<!-- .slide: class="small" -->

### なぜ GitLab に?

- グループ機能
  - ex. `チーム/プロジェクト/リポジトリ`
    - git submodule の相対URIで重要
    - issue 参照も ex. `X/Y/Z#番号`
  - 可視性・グループ参加可否の制御<small>（の階層化）</small>
- Self host で始められる
  - [IAP](https://cloud.google.com/iap) で守ってゼロトラスト化<small>(public でも安全 →全社 DX向き)</small>
  - 無課金スタート→実績積み
</script>
</section>
<section data-markdown>
<script type='text/template'>
## import どうだった？
</script>
</section>
<section data-markdown>
<script type='text/template'>
<!-- .slide: class="tiny" -->

### Gitea からの import

[公式機能あり](https://docs.gitlab.com/ee/user/project/import/gitea.html#import-your-project-from-gitea-to-gitlab)

- プロジェクト数が多いとWeb 画面の操作が大変

- 正常
  - リポジトリ
- 問題あり
  - issue が増えると取りこぼす<small>（gitea の API を叩くクライアントのページャのバグ）</small>
- 未対応
  - PR 上のコメント
  - Commit メッセージと issue のリンク
  - プロジェクト Wiki
</script>
</section>
<section>
<section data-markdown>
<script type='text/template'>
### どう解決したか

- GitLab のソースを読み解き切り貼り  
  gitlab-rails runner で動く gitea importer を書く
- それを呼び出す ruby スクリプトを Gitea 側の DB データから生成
- gitlab-rails runner に食わせる


<small>余談：出来た gitea importer を公開する時のライセンスはどうすれば？  
（アドバイス求む）</small>
</script>
</section>
<section data-markdown>
<script type='text/template'>
### 生成されたコードの例

```ruby
puts "Importing repo devteam/NRA2/yllib1"
imp = GiteaImport::ProjectImporter.new(clnt, root, {
    import_source: 'devteam/yllib1', 
    target_namespace: 'devteam/NRA2', 
    new_name: 'yllib1',
})
imp.execute

proj15 = imp.project
```
</script>
</section>
<section data-markdown>
<script type='text/template'>
```ruby
review5 = Review.create!(
  author: (User.find_by_email 'rkodama@ssri.com'), 
  project: proj15, 
  merge_request: MergeRequest.find_by(project: proj15, iid: 2), 
  created_at: '2021-05-28T03:54:40Z')
mr5 = MergeRequest.find_by(project: proj15, iid: 2)
```
</script>
</section>
<section data-markdown>
<script type='text/template'>
```ruby
origPos5 = Gitlab::Diff::Position.new(
  new_path: 'lib/Survey2.pm', 
  head_sha: '012286ff7ccbac5a01ae47c89ce282d80e225252', 
  start_sha: '7b7601ae0d141ccfd347b5f8755bc1f2f7e7c09c', 
  new_line: 503, 
  base_sha: '7b7601ae0d141ccfd347b5f8755bc1f2f7e7c09c', 
  position_type: 'text', old_path: 'lib/Survey2.pm')
print "diff_file => "; puts origPos5.diff_file(mr5)

origPos5.define_singleton_method(:find_diff_file_from) do |noteable| origPos5.diff_file(noteable) end

print "find_diff_file_from => "; puts origPos5.find_diff_file_from(mr5)
```
</script>
</section>
<section data-markdown>
<script type='text/template'>
<!-- .slide: class="tiny" -->

```ruby
reviewComment5 = Note.create!(
  importing: true,
  noteable_type: "Commit",
  author: (User.find_by_email 'rkodama@ssri.com'),
  project: (Project.find_by_full_path 'devteam/NRA2/yllib1'),
  position: Gitlab::Diff::Position.new(..),
  type: 'DiffNote',
  note: 'このコードは…',
  review: review5,
  noteable: mr5,
  original_position: origPos5)
```
</script>
</section>
<section data-markdown>
<script type='text/template'>
```ruby
unless origPos5.diff_file(mr5).line_for_position(origPos5)
  puts "  line_for_position is empty, monkey patching Note.create_diff_file..."
  reviewComment5.define_singleton_method(:create_diff_file) do end
end
reviewComment5.save
```
</script>
</section>
</section>
<section data-markdown>
<script type='text/template'>
### Redmine からの import
</script>
</section>

      </div>
    </div>

    <script src="/revealjs/lib/js/head.min.js"></script>
    <script src="/revealjs/js/reveal.js"></script>

    <script>
      Reveal.initialize({
        width: 960,
        height: 700,
        controls: true,
        progress: true,
        history: true,
        center: true,
        theme: Reveal.getQueryHash().theme, // available themes are in /css/theme
        transitionSpeed: Reveal.getQueryHash().speed || 'fast', // 
        transition: Reveal.getQueryHash().transition || 'linear', // default/cube/page/concave/zoom/linear/fade/none
        // Optional libraries used to extend on reveal.js
        dependencies: [
          { src: '/revealjs/lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: '/revealjs/plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: '/revealjs/plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: '/revealjs/plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: '/revealjs/plugin/zoom-js/zoom.js', async: true, condition: function() { return !!document.body.classList; } },
          { src: '/revealjs/plugin/notes/notes.js', async: true, condition: function() { return !!document.body.classList; } }
        ]
      });
    </script>
  </body>
</html>

